name: PR Gates

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
    branches:
      - master
      - main
      - develop

permissions:
  contents: read
  pull-requests: write

jobs:
  title-lint:
    name: title / lint
    runs-on: ubuntu-latest

    outputs:
      pr_type: ${{ steps.extract.outputs.type }}

    steps:
      - name: Validate PR title against contract regex
        id: validate
        shell: bash
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          REGEX='^(feat|fix|docs|refactor|test|chore|revert)(!)?(\([a-z0-9-]+\))?: .+'

          if [[ "$TITLE" =~ $REGEX ]]; then
            echo "success=true" >> "$GITHUB_OUTPUT"
            echo "message=PR title follows the required Conventional Commit format." >> "$GITHUB_OUTPUT"
          else
            echo "success=false" >> "$GITHUB_OUTPUT"
            echo "message=PR title does not follow the required format." >> "$GITHUB_OUTPUT"
          fi

      - name: Add label when title is invalid
        if: ${{ steps.validate.outputs.success == 'false' }}
        uses: actions/github-script@v7
        with:
          script: |
            const label = { name: "Title needs formatting", color: "EEEEEE" };
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            try {
              await github.rest.issues.getLabel({ owner, repo, name: label.name });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({ owner, repo, ...label });
              } else {
                throw e;
              }
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: [label.name],
            });

      - name: Remove label when title is valid
        if: ${{ steps.validate.outputs.success == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const labelName = "Title needs formatting";

            try {
              await github.rest.issues.removeLabel({ owner, repo, issue_number, name: labelName });
            } catch (e) {
              if (e.status !== 404) throw e;
            }

      - name: Sticky comment when title is invalid
        if: ${{ steps.validate.outputs.success == 'false' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: PR Title Format Warning
          recreate: true
          message: |
            ⚠️ **PR title does not follow the required format.** ⚠️

            Required regex:
            `^(feat|fix|docs|refactor|test|chore|revert)(!)?(\\([a-z0-9-]+\\))?: .+`

            Examples:
            - `feat(ci): add PR gates`
            - `fix(db): handle unique constraint`
            - `docs(readme): update contribution section`
            - `refactor(auth): simplify dependency graph`
            - `test(api): add user router tests`
            - `chore(ci): update workflows`
            - `revert: revert PR #123`
            - `feat!(api): breaking change`

      - name: Sticky comment when title is valid
        if: ${{ steps.validate.outputs.success == 'true' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: PR Title Format Warning
          recreate: true
          message: |
            ✅ PR title follows the required Conventional Commit format.

      - name: Extract PR type for version gate
        id: extract
        if: ${{ steps.validate.outputs.success == 'true' }}
        shell: bash
        run: |
          TITLE="${{ github.event.pull_request.title }}"

          # Must match the same contract regex
          if [[ "$TITLE" =~ ^(feat|fix|docs|refactor|test|chore|revert)(!)?(\([a-z0-9-]+\))?:\  ]]; then
            TYPE="${BASH_REMATCH[1]}"
            BANG="${BASH_REMATCH[2]}"
            if [[ -n "$BANG" ]]; then
              TYPE="${TYPE}!"
            fi
            echo "type=$TYPE" >> "$GITHUB_OUTPUT"
            echo "Detected PR type: $TYPE"
          else
            echo "ERROR: Could not extract type even though title was marked valid."
            exit 1
          fi

      - name: Fail workflow if PR title is invalid
        if: ${{ steps.validate.outputs.success == 'false' }}
        run: |
          echo "PR title does not follow the required format."
          exit 1

  branch-up-to-date:
    name: policy / branch-up-to-date
    runs-on: ubuntu-latest
    if: ${{ contains(fromJSON('["develop","master"]'), github.event.pull_request.base.ref) }}

    permissions:
        contents: read
        pull-requests: write

    steps:
      - name: Compare head vs base (behind check)
        id: compare
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const base = context.payload.pull_request.base.ref;   // develop | master
            const head = context.payload.pull_request.head.ref;

            const res = await github.rest.repos.compareCommits({
              owner,
              repo,
              base,
              head,
            });

            const behindBy = res.data.behind_by;
            core.info(`Base branch: ${base}`);
            core.info(`Head branch: ${head}`);
            core.info(`Commits behind base: ${behindBy}`);

            core.setOutput("behind_by", String(behindBy));
            core.setOutput("base", base);
            core.setOutput("head", head);

      - name: Sticky comment explaining how to update branch
        if: ${{ steps.compare.outputs.behind_by != '0' }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: Branch is not up to date
          recreate: true
          message: |
            **This branch is not up to date with the base branch.**

            - **Base:** `${{ steps.compare.outputs.base }}`
            - **Head:** `${{ steps.compare.outputs.head }}`
            - **Behind by:** `${{ steps.compare.outputs.behind_by }}` commit(s)

            ---
            ## How to fix it

            ### If the base branch is `develop`
            You can **merge or rebase** `develop` into your branch:

            **Option A — Merge (simpler):**
            ```bash
            git fetch origin
            git merge origin/develop
            git push
            ```

            **Option B — Rebase (cleaner):**
            ```bash
            git fetch origin
            git rebase origin/develop
            git push --force-with-lease
            ```

            ---
            ### If the base branch is `master`
            **Rebase is required** (keep linear history for release):

            ```bash
            git fetch origin
            git checkout develop
            git rebase origin/master
            git push --force-with-lease
            ```

            ---
            After pushing, this check will re-run and should pass.

      - name: Fail if branch is behind base
        if: ${{ steps.compare.outputs.behind_by != '0' }}
        run: |
          echo "ERROR: Head branch '${{ steps.compare.outputs.head }}' is behind base '${{ steps.compare.outputs.base }}' by ${{ steps.compare.outputs.behind_by }} commit(s)."
          exit 1

  version-bump:
    name: version / bump-check
    runs-on: ubuntu-latest
    needs: [title-lint, branch-up-to-date]

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read BASE pyproject.toml into temp file
        shell: bash
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git show "origin/${BASE_REF}:apps/api/pyproject.toml" > /tmp/base-pyproject.toml

      - name: Run version bump validation
        run: |
          python .github/tooling/ci/validate_version_bump.py \
            --head-path apps/api/pyproject.toml \
            --base-path /tmp/base-pyproject.toml \
            --pr-type "${{ needs.title-lint.outputs.pr_type }}"

  source-branch-policy:
    name: policy / allow-only-develop-to-master
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.base.ref == 'master' }}
    steps:
      - name: Enforce develop -> master only
        run: |
          echo "Base: ${{ github.event.pull_request.base.ref }}"
          echo "Head: ${{ github.event.pull_request.head.ref }}"
          if [ "${{ github.event.pull_request.head.ref }}" != "develop" ]; then
            echo "ERROR: Only PRs from 'develop' into 'master' are allowed."
            exit 1
          fi
          echo "OK: PR is develop -> master."
